const EVENTS={join:'join',leave:'leave',message:'message'},STALE_CONNECTION_THRESHOLD_SECONDS=100,SOCKET_POLLING_RATE=1e4;let now=()=>{return new Date().getTime()},secondsSince=a=>{return(now()-a)/1e3};export class Channel{constructor(a,b){this.topic=a,this.socket=b,this.onMessageHandlers=[]}join(){this.socket.ws.send(JSON.stringify({event:EVENTS.join,topic:this.topic}))}leave(){this.socket.ws.send(JSON.stringify({event:EVENTS.leave,topic:this.topic}))}handleMessage(a){this.onMessageHandlers.forEach(b=>{b.subject===a.subject&&b.callback(a.payload)})}on(a,b){this.onMessageHandlers.push({subject:a,callback:b})}push(a,b){this.socket.ws.send(JSON.stringify({event:EVENTS.message,topic:this.topic,subject:a,payload:b}))}}export class Socket{constructor(a){this.endpoint=a,this.ws=null,this.channels=[],this.lastPing=now(),this.reconnectTries=0,this.attemptReconnect=!0}_connectionIsStale(){return secondsSince(this.lastPing)>STALE_CONNECTION_THRESHOLD_SECONDS}_reconnect(){clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout(()=>{this.reconnectTries++,this.connect(this.params),this._reconnect()},this._reconnectInterval())}_reconnectInterval(){return[1000,2000,5000,10000][this.reconnectTries]||1e4}_poll(){this.pollingTimeout=setTimeout(()=>{this._connectionIsStale()?this._reconnect():this._poll()},SOCKET_POLLING_RATE)}_startPolling(){clearTimeout(this.pollingTimeout),this._poll()}_handlePing(){this.lastPing=now()}_reset(){clearTimeout(this.reconnectTimeout),this.reconnectTries=0,this.attemptReconnect=!0,this._startPolling()}connect(a){this.params=a;let b={location:window.location.hostname,port:window.location.port,protocol:'https:'===window.location.protocol?'wss:':'ws:'};return a&&Object.assign(b,a),b.port&&(b.location+=`:${b.port}`),new Promise(c=>{this.ws=new WebSocket(`${b.protocol}//${b.location}${this.endpoint}`),this.ws.onmessage=f=>{this.handleMessage(f)},this.ws.onclose=()=>{this.attemptReconnect&&this._reconnect()},this.ws.onopen=()=>{this._reset(),c()}})}disconnect(){this.attemptReconnect=!1,clearTimeout(this.pollingTimeout),clearTimeout(this.reconnectTimeout),this.ws.close()}channel(a){let b=new Channel(a,this);return this.channels.push(b),b}handleMessage(a){if('ping'===a.data)return this._handlePing();let b=JSON.parse(a.data);this.channels.forEach(c=>{c.topic===b.topic&&c.handleMessage(b)})}}module.exports={Socket:Socket},document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('a[data-method=\'delete\']').forEach(function(a){a.addEventListener('click',function(b){b.preventDefault();var c=a.getAttribute('data-confirm')||'Are you sure?';if(confirm(c)){var d=document.createElement('form'),f=document.createElement('input');d.setAttribute('action',a.getAttribute('href')),d.setAttribute('method','POST'),f.setAttribute('type','hidden'),f.setAttribute('name','_method'),f.setAttribute('value','DELETE'),d.appendChild(f),document.body.appendChild(d),d.submit()}return!1})})});
